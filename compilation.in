#!/bin/bash
# Bootstrap file, run during the final stage of bootstrapping

mkdir -p "/rpi-build"


# Where gnss-sdr will live
gnss_dir="$1"

# What is the gnss-sdr repository url?
gnss_sdr_repo="$2"

# What is the gnss-sdr branch?
gnss_sdr_branch="$3"

# How many cores on the host machine
procs=$4

gnss_sdr_src="/build/gnss-sdr"

echo "Cloning branch ${gnss_sdr_branch} from ${gnss_sdr_repo}"
git clone -b "${gnss_sdr_branch}" ${gnss_sdr_repo} ${gnss_sdr_src}

cd "/rpi-build"
if [ ! -d gtest-1.7.0 ]; then
    wget http://googletest.googlecode.com/files/gtest-1.7.0.zip
    unzip gtest-1.7.0.zip
fi
cd gtest-1.7.0
./configure
make -j${procs}
cd ..
export GTEST_DIR="/rpi-build/gtest-1.7.0"


# Make doubly sure packages are available
apt-get install -y libssl-dev libboost-all-dev libuhd-dev libosmosdr-dev \
    gnuradio gnuradio-dev gr-osmosdr wicd-curses libusb-dev libusb-1.0-0-dev \
    gfortran libopenblas-dev liblapack-dev libarmadillo-dev liblog4cpp5-dev

# Compile and install gnss-sdr
build_dir="${gnss_sdr_src}/build"
mkdir -p "${build_dir}"
cd "${build_dir}"

GTEST_DIR="/rpi-build/gtest-1.7.0" cmake -DENABLE_RTLSDR=ON ../

make -j${procs}
make install
ldconfig
cd /

# Copy gnss-sdr and config to the gnss directory
mkdir -p "${gnss_dir}"
mv "${gnss_sdr_src}/install" "${gnss_dir}"
mv "${gnss_sdr_src}/data" "${gnss_dir}"
mv "${gnss_sdr_src}/conf" "${gnss_dir}"

rm -rf "/rpi-build"
rm -f compilation
