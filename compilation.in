#!/bin/bash
# Bootstrap file, run during the final stage of bootstrapping

mkdir "/rpi-build"


# Where gnss-sdr will live
gnss_dir="$1"

# How many cores on the host machine
procs=$2

gnss_sdr_src="/build/gnss-sdr"
gnss_sdr_repo="git://git.code.sf.net/p/gnss-sdr/cttc"

git clone --depth 1 ${gnss_sdr_repo} ${gnss_sdr_src}

cd "/rpi-build"
wget http://googletest.googlecode.com/files/gtest-1.7.0.zip
unzip gtest-1.7.0.zip
cd gtest-1.7.0
./configure
make -j${procs}
cd ..
export GTEST_DIR="/rpi-build/gtest-1.7.0"

compile ()
{
mkdir -p "$1/build"
cd "$1/build"

# gnss-sdr not always up to date :)
gfpath="/usr/lib/gcc/arm-linux-gnueabihf/4.9"

LIB="$LIB:${gfpath}" cmake \
    -DENABLE_RTLSDR=ON \
    -DENABLE_GENERIC_ARCH=ON \
    ../

make -j${procs}
make install
ldconfig
cd /
}

# Make doubly sure packages are available
apt-get install -y libssl-dev libboost-all-dev libuhd-dev libosmosdr-dev gnuradio gnuradio-dev gr-osmosdr wicd-curses \
    libusb-dev libusb-1.0-0-dev gfortran libopenblas-dev liblapack-dev libarmadillo-dev

# Compile and install gnss-sdr

# compile ${gnss_sdr_src}/drivers/gr-gn3s
compile ${gnss_sdr_src}

# Copy gnss-sdr and config to the gnss directory
mkdir -p "${gnss_dir}"
mv "${gnss_sdr_src}/install" "${gnss_dir}"
mv "${gnss_sdr_src}/data" "${gnss_dir}"
mv "${gnss_sdr_src}/conf" "${gnss_dir}"

rm -rf "/rpi-build"
rm -f compilation
